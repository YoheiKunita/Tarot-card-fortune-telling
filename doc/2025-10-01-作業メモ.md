# 2025-10-01 作業メモ

## 概要
- 画面遷移とボタン構成の提案を反映し、スタートメニュー/展開選択/リーディング/アドバイス周辺のUXを調整。
- AIアドバイス表示を暗転モーダルに統一し、再実行時の残留と再生成を防止（キャッシュ対応）。
- 右下アクションバーが全リビール前に出てしまう問題を修正。
- スタートメニューに「元の画面に戻る」ボタンを追加（リーディングへ復帰）。

## 変更点（機能）
- スタートメニュー再構成（最小差分）
  - メイン：
    - 3枚リーディング（primary）
    - 1枚引き
    - 詳細な展開を選ぶ…
    - 設定
  - メニュー表示時に「元の画面に戻る」ボタンを最上部へ動的挿入（盤面が存在する場合のみ表示）。
- 詳細な展開パネル
  - グリッド（1〜10）→ ドロップダウン「枚数」＋テキスト「テーマ」＋「開始」に差し替え（既存UIに対して重複しないよう存在チェック）。
- アクションバー表示タイミング
  - 全カードのリビール完了後にのみ表示。ディール中や一部リビールでは非表示のまま。
- AIアドバイスのUX
  - 暗転モーダル（`#adviceOverlay`）で中央表示、右下に「戻る」ボタン配置。
  - 旧`#adviserOut`はモーダル使用時は非表示に統一。
  - リトライ/メニュー/開始時に、モーダルと旧表示の両方を確実にクリア。
- AIアドバイスのキャッシュ
  - キー：テーマ＋（カード名｜正逆｜スロット）の並び（並び替え済）
  - 保存先：`localStorage('adviceCache.map')`
  - 同一条件で再実行時は保存済み要約を即時再表示（問い合わせなし）。

## 変更点（実装）
- `src/index.html`
  - アドバイス用モーダルDOMを追加（`#adviceOverlay`, `#adviceContent`, `#btnAdviceClose`）。
  - 新規モジュール `override-advice.js` を `renderer.js` の後で読み込み。
- `src/styles.css`
  - アドバイスモーダル一式のスタイル（暗転、パネル、閉じるボタン）を追加。
- `src/renderer.js`
  - アクション自動表示のMutationObserverを実質無効化（早出し防止）。
  - `showStartMenu()`/`startSpread()`/`Retry`時に、アドバイス表示（モーダル/旧パネル）のクリア処理を追加。
  - スタートメニュー表示時に「元の画面に戻る」ボタンを動的に挿入・表示制御。
- `src/override-advice.js`（新規）
  - `#btnAdvise` を監視して差し替え（MutationObserver）し、常にモーダル＋キャッシュ動作にオーバーライド。
  - モーダルの開閉、ロード中表示、キャッシュ読み書き、旧表示の抑止を実装。
  - `メニュー`/`リトライ`押下時のアドバイス表示消去を補完。

## 動作確認（要点）
1) 起動→スタートメニューが「3枚/1枚/詳細/設定」で構成されている。
2) 詳細な展開で枚数とテーマを設定→開始でディール。
3) 全リビール完了までアクションバーが出ない。完了後に出る。
4) AIアドバイス押下→画面が暗転し中央モーダルに「生成中…」→要約が表示。「戻る」で閉じる。
5) 同一条件でAIアドバイスを押すとキャッシュされた要約が即時表示される。
6) メニュー表示時に「元の画面に戻る」が表示され、クリックで盤面に復帰できる。
7) リトライ/開始/メニュー遷移で前のアドバイス表示が残らない。

## 残課題/メモ
- スタートメニューの再構成は既存の動的生成と干渉しないようガードを入れているが、将来のUI変更時は一元化したほうが安全。
- アドバイスキャッシュの保持期間やリセット導線（設定画面に「キャッシュ削除」追加など）は今後検討。
- 一部文字化けが出る環境があるため、日本語ラベルは実機での表示確認を推奨。

