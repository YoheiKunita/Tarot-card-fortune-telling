%EF%BB%BF# 作業メモ（2025-09-28）

## 概要
- adviserモジュールをアプリ本体に内蔵統合し、UIから要約を生成できる土台を構築。
- テスト環境も内蔵ライブラリを参照するよう一本化し、重複を削除。

## 変更点
- ライブラリ内蔵化：`lib/tarot-adviser/`（Domain/PromptBuilder/LLMClient/Parser/UseCase）を新設。
- preload：内蔵のみを `require(__dirname + '/lib/tarot-adviser')` で読込。失敗時はインライン・スタブでフォールバックし、`window.adviser.generate()` を常に提供。
- UI連携：
  - 「AIアドバイス」ボタンと出力パネルを追加（`src/index.html` / `src/styles.css`）。
  - クリック時にめくれたカード情報を収集→ `adviser.generate()` 呼び出し→ 要約表示（`src/renderer.js`）。
  - 配布時にスロットへ `data-*`（name/position/slot）を保存（`src/modes/shared.js`）。
- テスト整理：
  - すべて内蔵ライブラリ参照に変更（`tarot-adviser-test/doc/tarot-adviser-test/*.js` の require パスを `lib/tarot-adviser` に修正）。
  - 旧 `tarot-adviser-test/lib/tarot-adviser/*` を削除。
  - `run-all.cmd` に UTF-8（`chcp 65001`）適用、`test-schema-mismatch.js` を追加。
  - `package.json` に `npm run test:adviser` を追加。

## 動作確認
- `npm run test:adviser` で全テスト PASS を確認。
- アプリ起動時、Console に `[preload] adviser module loaded (internal only): true` を出力。
- カードめくり後に「AIアドバイス」で要約表示（API Key 未設定時はスタブ応答）。

## 既知事項
- 一部環境で「アドバイス機能が利用できません」表示が残る可能性 → preload 側でインライン・スタブを実装済み。次回、実機 Console ログで読込経路を最終確認。

## 次にやること（提案）
- Console ログ収集と読込経路の最終確認（内蔵パス固定の検証）。
- エラー表示の改善（API 失敗やフォールバック時のユーザー通知）。
- Prompt の微調整（安定化策は後回しのまま、最低限の指示強化）。
