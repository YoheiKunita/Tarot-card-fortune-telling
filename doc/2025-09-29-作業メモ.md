# 2025-09-29 作業メモ

目的: AIアドバイス機能の安定化と日本語化、デバッグ容易性の向上。

実施内容
- フォールバック強化（ブラウザ直実行対応）
  - `src/index.html`: `window.adviser.generate` のインライン・スタブを追加し、日本語文面に統一。
- AdviserService の導入
  - `lib/adviser-service.js` 追加: 安定API `generate()` を提供（rejectせずresolve／OpenAI失敗時はスタブへ自動フォールバック／タイムアウト・簡易リトライ）。
  - `preload.js`: `AdviserService` を採用し `window.adviser.generate` をブリッジ。コンソールに状態を出力。
- レンダラーの堅牢化
  - `src/renderer.js`: `window.prompt` 非対応問題に対処するため、最終オーバーライドのクリックハンドラを追加（`#readingTopic` または `localStorage.readingTopic` を質問として使用、常に画面に結果を表示）。
- メニューバーの常時表示・DevTools 利用性向上
  - `main.js`: メニュー有効化（`buildMenu(win)`）、`autoHideMenuBar:false`、`win.setMenuBarVisibility(true)`。
- preload 読込エラー対策
  - `main.js`: `webPreferences.sandbox:false` を追加（preload 内で Node の `require` を使用するため）。
- 日本語出力の明示化
  - `lib/tarot-adviser/promptBuilder.js`: 生成ルールに「日本語で記述」を追加。
  - `lib/tarot-adviser/llmClient.js`: system メッセージに日本語指示を追加。

確認事項・ログ
- DevTools Console:
  - `[preload] adviser module loaded (internal only): true` を確認（内蔵モジュール読込OK）。
  - 実行時 `Adviser meta: { backend: 'openai' | 'stub', ... }` で経路確認。
- 画面左下 `#adviserOut` に結果が表示される（失敗時でもフォールバック文面）。

発生した問題と対処
- `Unable to load preload script`: sandbox 環境で preload が失敗 → `sandbox:false` を設定して解消。
- `prompt() is and will not be supported.`: Electron の制約 → prompt を廃止し、UI入力/保存値を使用するハンドラへ差替え。
- アドバイスが英語で出力: プロンプトに日本語指示を追加、system メッセージも日本語指定に変更。

残課題/次回以降
- `src/renderer.js` 内の旧ハンドラと新ハンドラの重複整理（リファクタで1本化）。
- UIに「使用バックエンド（openai/stub）」の小さな表示を追加（ユーザー向け診断補助）。
- `AdviserService` に OpenAI 直呼びを内蔵し、`lib/tarot-adviser` への依存をオプション化（さらなる安定化）。
- 簡易ユニットテストの追加（正規化、タイムアウト/リトライ、フォールバック経路、i18n）。

メモ
- 設定（API Key/Model）はスタートメニューの「設定」で保存可能。モデルは既定 `gpt-4o-mini`。
- 1枚引き/3枚引きとも、カードをめくると「AIアドバイス」実行可。常に何らかの結果を表示する設計。

