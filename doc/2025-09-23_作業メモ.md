# 作業メモ（2025-09-23）

## 概要
- 配布アニメが始まらない・クリックで表にならない不具合を修正。
- 配布演出とUI導線を改善（最初の6枚を右下の山へ、7枚目から場へ配る／解説表示の見やすさ向上）。
- 「もう一度」で裏返して山に戻すアニメを“倍速”に調整。

## 不具合修正
- flipとレイアウト回転（配置角度）の競合解消：
  - `.card .inner` の transform を `--base-rot` で表現し、`rotateY`（反転）と合成可能に変更。
- 動的生成カードの初期表示を非表示に：
  - 生成時に `.card hidden` を付与し、配る直前まで不可視化。
- 左上から飛ぶように見える問題：
  - 飛行生成時は0msで山座標に即配置→その後のみトランジションを有効化。
- 共有関数の未インポートとグローバル参照の安定化：
  - `renderer.js` で `shuffle/createFlying/createDealingFlight/setFrontOnly/sleep` を import。
  - `tarot-data.js` から `window.TAROT_CARDS/BLANK_DATA_URI` を公開。

## UI/挙動の変更
- スタート後は「枚数＋占う内容」選択画面に遷移し、開始で配布。
- 配布完了時点で右下アクション（スタート/もう一度）を表示（めくり完了待ちを廃止）。
- 解説パネル `.info` の視認性向上：
  - 横幅最大18em（かつ90vw上限）、カード中央下に表示、z-index調整。
  - 表＋ホバー時のみ表示の挙動は維持。

## 配布ロジックと演出
- 「最初の6枚を右下へ→7枚目から場へ」に変更：
  - `#stage` 直下に `.oppile`（右下の山）を生成。
  - 配布前に6枚を「山から少し抜ける→右下へ飛ぶ」の2段階アニメで移動。
  - 6枚移動ごとに `.oppile .pilecard` を追加し、右下に重ねて可視化（消えない）。
  - 抽出は `deck.slice(6, 6+n)` で7枚目から配る。

## 「もう一度」の挙動
- 場のカードを裏返してから山に戻す→右下の6枚も山に戻す→再び6枚を右下へ→配り直し。
- 戻しアニメは配布時の“倍速”（timeScale=0.5：時間を半分）で実行。

## アニメーション基盤
- `createDealingFlight(from, to, opts)` を新規追加：
  - ステップ1：山から少し抜ける（方向ベクトルに沿って約40px）。
  - ステップ2：目的地へ飛行。
- `createFlying`/`createDealingFlight` に `timeScale` を追加して速度調整可能に。
- 初期配置は transition 0ms→山位置→再計算後に本アニメ開始。

## 変更ファイル
- `src/styles.css`
  - `--base-rot` 合成対応、`.info` の中央寄せ/幅拡大/z-index。
  - `.oppile`（右下の山）と `.oppile .pilecard` のスタイル追加。
- `src/modes/shared.js`
  - `createDealingFlight` 追加。
  - `createFlying`/`createDealingFlight` に `timeScale` と初期配置0msを導入。
- `src/renderer.js`
  - 動的UI（選択→開始）、カード生成を hidden 初期化。
  - `ensureOppPile`/`moveFirstSixToOpposite`（6枚右下へ）と `returnOppPile`（右下→山へ）の実装。
  - `startSpread`/`btnRetry` を「戻す→右下へ6枚→配布」に整理、戻しは倍速。
- `src/modes/three-card.js` / `src/modes/one-oracle.js`
  - 配布を `createDealingFlight` に置換（山から抜けて→飛ぶ）。
- `src/tarot-data.js`
  - `window.TAROT_CARDS` / `window.BLANK_DATA_URI` を設定。

## 確認メモ
- 初期表示：右下は空（カードは置かれていない）。
- 開始後：6枚が右下に移動し、7枚目から場へ配布。右下の山は可視のまま残る。
- 表になったカードをホバーで拡大すると、横18文字相当の幅で解説が表示。
- 「もう一度」：裏返して倍速で山に戻る→右下の6枚も山に戻る→再配布。

## 補足・今後の調整候補
- 右下の山の重なりオフセット・角度、スライド距離、速度（timeScale）は調整可能。
- テキストのフォントサイズや行間など、読みやすさの微調整も対応可能。
